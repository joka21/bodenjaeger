<?php
/**
 * Jaeger Plugin - Product Data REST API
 *
 * Stellt ALLE 30+ Custom Fields für Next.js Headless Frontend bereit
 *
 * @package JaegerPlugin
 * @since 1.1.0
 */

if (!defined('ABSPATH')) {
    exit;
}

/**
 * REST API für vollständige Produktdaten
 */
class Jaeger_Product_Data_API {

    const NAMESPACE = 'jaeger/v1';

    public function __construct() {
        add_action('rest_api_init', array($this, 'register_routes'));
    }

    /**
     * REST API Routes registrieren
     */
    public function register_routes() {

        // Einzelprodukt mit ALLEN Custom Fields
        register_rest_route(self::NAMESPACE, '/products/(?P<id>\d+)', array(
            'methods' => 'GET',
            'callback' => array($this, 'get_product_with_custom_fields'),
            'permission_callback' => '__return_true',
            'args' => array(
                'id' => array(
                    'validate_callback' => function($param) {
                        return is_numeric($param);
                    }
                )
            )
        ));

        // Mehrere Produkte auf einmal (z.B. für Kategorie-Seiten)
        register_rest_route(self::NAMESPACE, '/products', array(
            'methods' => 'GET',
            'callback' => array($this, 'get_products_list'),
            'permission_callback' => '__return_true',
            'args' => array(
                'category' => array(
                    'required' => false,
                    'type' => 'string'
                ),
                'per_page' => array(
                    'required' => false,
                    'type' => 'integer',
                    'default' => 20
                ),
                'page' => array(
                    'required' => false,
                    'type' => 'integer',
                    'default' => 1
                )
            )
        ));

        // Produktkategorien mit Produktanzahl
        register_rest_route(self::NAMESPACE, '/categories', array(
            'methods' => 'GET',
            'callback' => array($this, 'get_categories'),
            'permission_callback' => '__return_true'
        ));
    }

    /**
     * Einzelprodukt mit allen Custom Fields
     */
    public function get_product_with_custom_fields($request) {
        try {
            $product_id = intval($request['id']);
            $product = wc_get_product($product_id);

            if (!$product) {
                return new WP_Error('product_not_found', 'Produkt nicht gefunden', array('status' => 404));
            }

            // Standard WooCommerce Daten
            $data = array(
                'id' => $product->get_id(),
                'name' => $product->get_name(),
                'slug' => $product->get_slug(),
                'permalink' => get_permalink($product_id),
                'type' => $product->get_type(),
                'status' => $product->get_status(),
                'featured' => $product->is_featured(),
                'catalog_visibility' => $product->get_catalog_visibility(),
                'description' => $product->get_description(),
                'short_description' => $product->get_short_description(),
                'sku' => $product->get_sku(),
                'date_created' => $product->get_date_created() ? $product->get_date_created()->date('c') : null,
                'date_modified' => $product->get_date_modified() ? $product->get_date_modified()->date('c') : null,
            );

            // Bilder
            $data['images'] = $this->get_product_images($product);

            // Kategorien
            $data['categories'] = $this->get_product_categories($product);

            // Tags
            $data['tags'] = $this->get_product_tags($product);

            // Preise
            $data['prices'] = array(
                'price' => $product->get_price(),
                'regular_price' => $product->get_regular_price(),
                'sale_price' => $product->get_sale_price(),
                'on_sale' => $product->is_on_sale(),
                'date_on_sale_from' => $product->get_date_on_sale_from() ? $product->get_date_on_sale_from()->date('c') : null,
                'date_on_sale_to' => $product->get_date_on_sale_to() ? $product->get_date_on_sale_to()->date('c') : null,
                'price_html' => $product->get_price_html()
            );

            // Lagerbestand
            $data['stock'] = array(
                'stock_status' => $product->get_stock_status(),
                'stock_quantity' => $product->get_stock_quantity(),
                'manage_stock' => $product->get_manage_stock(),
                'backorders' => $product->get_backorders(),
                'backorders_allowed' => $product->backorders_allowed(),
                'backordered' => $product->is_on_backorder()
            );

            // Versand
            $data['shipping'] = array(
                'weight' => $product->get_weight(),
                'length' => $product->get_length(),
                'width' => $product->get_width(),
                'height' => $product->get_height(),
                'shipping_class' => $product->get_shipping_class()
            );

            // ALLE JAEGER CUSTOM FIELDS (30+ Felder)
            $data['jaeger_fields'] = $this->get_all_jaeger_custom_fields($product_id);

            // Related Products
            $data['related_products'] = $product->get_upsell_ids();
            $data['cross_sell_products'] = $product->get_cross_sell_ids();

            // Attributes (falls Variable Product)
            if ($product->is_type('variable')) {
                $data['attributes'] = $this->get_product_attributes($product);
                $data['variations'] = $product->get_available_variations();
            }

            return rest_ensure_response($data);

        } catch (Exception $e) {
            Jaeger_Error_Handler::log_error(
                'API get_product_with_custom_fields error: ' . $e->getMessage(),
                Jaeger_Error_Handler::ERROR_LEVEL_ERROR,
                array('product_id' => $product_id)
            );

            return new WP_Error('api_error', 'Fehler beim Laden der Produktdaten', array('status' => 500));
        }
    }

    /**
     * ALLE JAEGER CUSTOM FIELDS
     *
     * Hier sind ALLE 30+ Custom Fields aus backend-zusatzfelder.php
     */
    private function get_all_jaeger_custom_fields($product_id) {
        return array(
            // Test & Anzeige
            'testdummy' => get_post_meta($product_id, '_testdummy', true),
            'show_text_produktuebersicht' => get_post_meta($product_id, '_show_text_produktuebersicht', true) === 'yes',
            'text_produktuebersicht' => get_post_meta($product_id, '_text_produktuebersicht', true),

            // UVP-System
            'show_uvp' => get_post_meta($product_id, '_show_uvp', true) === 'yes',
            'uvp' => floatval(get_post_meta($product_id, '_uvp', true)),
            'uvp_paketpreis' => floatval(get_post_meta($product_id, '_uvp_paketpreis', true)),

            // Preise
            'paketpreis' => floatval(get_post_meta($product_id, '_paketpreis', true)),
            'paketpreis_s' => floatval(get_post_meta($product_id, '_paketpreis_s', true)),

            // Paket-Details
            'paketinhalt' => floatval(get_post_meta($product_id, '_paketinhalt', true)),
            'einheit' => get_post_meta($product_id, '_einheit', true),
            'einheit_short' => get_post_meta($product_id, '_einheit_short', true),
            'verpackungsart' => get_post_meta($product_id, '_verpackungsart', true),
            'verpackungsart_short' => get_post_meta($product_id, '_verpackungsart_short', true),
            'verschnitt' => floatval(get_post_meta($product_id, '_verschnitt', true)) ?: 5,

            // Lieferzeit
            'show_lieferzeit' => get_post_meta($product_id, '_show_lieferzeit', true) === 'yes',
            'lieferzeit' => get_post_meta($product_id, '_lieferzeit', true),

            // Beschreibung
            'artikelbeschreibung' => get_post_meta($product_id, '_artikelbeschreibung', true),

            // Set-Angebot aktivieren/deaktivieren
            'show_setangebot' => get_post_meta($product_id, '_show_setangebot', true) === 'yes',

            // Set-Angebot Konfiguration
            'setangebot' => $this->get_setangebot_fields($product_id),

            // Zusatzprodukte
            'zusatzprodukte' => $this->get_zusatzprodukte_fields($product_id),

            // Styling-Optionen (aus backend-aktionen.php)
            'styling' => $this->get_styling_fields($product_id)
        );
    }

    /**
     * Set-Angebot Felder
     */
    private function get_setangebot_fields($product_id) {
        $show_setangebot = get_post_meta($product_id, '_show_setangebot', true);

        if ($show_setangebot !== 'yes') {
            return null;
        }

        return array(
            'titel' => get_post_meta($product_id, '_setangebot_titel', true) ?: 'Komplett-Set',
            'rabatt' => floatval(get_post_meta($product_id, '_setangebot_rabatt', true)),

            // Berechnete Werte (vom Backend)
            'einzelpreis' => floatval(get_post_meta($product_id, '_setangebot_einzelpreis', true)),
            'gesamtpreis' => floatval(get_post_meta($product_id, '_setangebot_gesamtpreis', true)),
            'ersparnis_euro' => floatval(get_post_meta($product_id, '_setangebot_ersparnis_euro', true)),
            'ersparnis_prozent' => floatval(get_post_meta($product_id, '_setangebot_ersparnis_prozent', true)),

            // Styling
            'text_color' => get_post_meta($product_id, '_setangebot_text_color', true),
            'text_size' => get_post_meta($product_id, '_setangebot_text_size', true),
            'button_style' => get_post_meta($product_id, '_setangebot_button_style', true),

            // Standard-Produkte
            'standard_daemmung_id' => intval(get_post_meta($product_id, '_standard_addition_daemmung', true)),
            'standard_sockelleisten_id' => intval(get_post_meta($product_id, '_standard_addition_sockelleisten', true)),

            // Optional wählbare Produkte
            'option_daemmung_ids' => $this->parse_option_products($product_id, 'daemmung'),
            'option_sockelleisten_ids' => $this->parse_option_products($product_id, 'sockelleisten'),

            // Erweiterte Daten: Standard-Produkte mit Details
            'standard_daemmung' => $this->get_simple_product_data(
                intval(get_post_meta($product_id, '_standard_addition_daemmung', true))
            ),
            'standard_sockelleisten' => $this->get_simple_product_data(
                intval(get_post_meta($product_id, '_standard_addition_sockelleisten', true))
            )
        );
    }

    /**
     * Zusatzprodukte Felder
     */
    private function get_zusatzprodukte_fields($product_id) {
        return array(
            'daemmung' => array(
                'standard_id' => intval(get_post_meta($product_id, '_standard_addition_daemmung', true)),
                'options_ids' => $this->parse_option_products($product_id, 'daemmung'),
                'standard' => $this->get_simple_product_data(
                    intval(get_post_meta($product_id, '_standard_addition_daemmung', true))
                ),
                'options' => $this->get_multiple_products_data(
                    $this->parse_option_products($product_id, 'daemmung')
                )
            ),
            'sockelleisten' => array(
                'standard_id' => intval(get_post_meta($product_id, '_standard_addition_sockelleisten', true)),
                'options_ids' => $this->parse_option_products($product_id, 'sockelleisten'),
                'standard' => $this->get_simple_product_data(
                    intval(get_post_meta($product_id, '_standard_addition_sockelleisten', true))
                ),
                'options' => $this->get_multiple_products_data(
                    $this->parse_option_products($product_id, 'sockelleisten')
                )
            )
        );
    }

    /**
     * Styling-Felder
     */
    private function get_styling_fields($product_id) {
        return array(
            'text_color' => get_post_meta($product_id, '_text_color', true),
            'text_size' => get_post_meta($product_id, '_text_size', true),
            'button_style' => get_post_meta($product_id, '_button_style', true)
        );
    }

    /**
     * Parse kommagetrennte Produkt-IDs
     */
    private function parse_option_products($product_id, $category) {
        $options_string = get_post_meta($product_id, '_option_products_' . $category, true);
        if (empty($options_string)) {
            return array();
        }
        return array_map('intval', explode(',', $options_string));
    }

    /**
     * Einfache Produktdaten (für Zusatzprodukte)
     */
    private function get_simple_product_data($product_id) {
        if (!$product_id) {
            return null;
        }

        $product = wc_get_product($product_id);
        if (!$product) {
            return null;
        }

        return array(
            'id' => $product->get_id(),
            'name' => $product->get_name(),
            'slug' => $product->get_slug(),
            'price' => floatval($product->get_price()),
            'regular_price' => floatval($product->get_regular_price()),
            'sale_price' => $product->get_sale_price() ? floatval($product->get_sale_price()) : null,
            'image' => wp_get_attachment_url($product->get_image_id()),
            'paketinhalt' => floatval(get_post_meta($product_id, '_paketinhalt', true)),
            'einheit_short' => get_post_meta($product_id, '_einheit_short', true)
        );
    }

    /**
     * Mehrere Produkte laden
     */
    private function get_multiple_products_data($product_ids) {
        $products = array();
        foreach ($product_ids as $id) {
            $data = $this->get_simple_product_data($id);
            if ($data) {
                $products[] = $data;
            }
        }
        return $products;
    }

    /**
     * Produktliste (mit Pagination)
     */
    public function get_products_list($request) {
        try {
            $category = $request->get_param('category');
            $per_page = intval($request->get_param('per_page')) ?: 20;
            $page = intval($request->get_param('page')) ?: 1;

            $args = array(
                'post_type' => 'product',
                'posts_per_page' => $per_page,
                'paged' => $page,
                'post_status' => 'publish',
                'orderby' => 'menu_order',
                'order' => 'ASC'
            );

            // Kategorie-Filter
            if ($category) {
                $args['tax_query'] = array(
                    array(
                        'taxonomy' => 'product_cat',
                        'field' => 'slug',
                        'terms' => $category
                    )
                );
            }

            $query = new WP_Query($args);

            $products = array();
            if ($query->have_posts()) {
                while ($query->have_posts()) {
                    $query->the_post();
                    $product_id = get_the_ID();

                    // Mini-Version für Listen
                    $product = wc_get_product($product_id);
                    if ($product) {
                        $products[] = array(
                            'id' => $product_id,
                            'name' => $product->get_name(),
                            'slug' => $product->get_slug(),
                            'permalink' => get_permalink($product_id),
                            'price' => floatval($product->get_price()),
                            'regular_price' => floatval($product->get_regular_price()),
                            'on_sale' => $product->is_on_sale(),
                            'image' => wp_get_attachment_url($product->get_image_id()),
                            'categories' => $this->get_product_categories($product),
                            'has_setangebot' => get_post_meta($product_id, '_show_setangebot', true) === 'yes'
                        );
                    }
                }
                wp_reset_postdata();
            }

            $response = array(
                'products' => $products,
                'pagination' => array(
                    'total' => $query->found_posts,
                    'total_pages' => $query->max_num_pages,
                    'current_page' => $page,
                    'per_page' => $per_page
                )
            );

            return rest_ensure_response($response);

        } catch (Exception $e) {
            Jaeger_Error_Handler::log_error(
                'API get_products_list error: ' . $e->getMessage(),
                Jaeger_Error_Handler::ERROR_LEVEL_ERROR
            );

            return new WP_Error('api_error', 'Fehler beim Laden der Produktliste', array('status' => 500));
        }
    }

    /**
     * Kategorien mit Produktanzahl
     */
    public function get_categories($request) {
        $terms = get_terms(array(
            'taxonomy' => 'product_cat',
            'hide_empty' => true,
            'orderby' => 'name',
            'order' => 'ASC'
        ));

        $categories = array();
        foreach ($terms as $term) {
            $thumbnail_id = get_term_meta($term->term_id, 'thumbnail_id', true);

            $categories[] = array(
                'id' => $term->term_id,
                'name' => $term->name,
                'slug' => $term->slug,
                'count' => $term->count,
                'description' => $term->description,
                'parent' => $term->parent,
                'image' => $thumbnail_id ? wp_get_attachment_url($thumbnail_id) : null
            );
        }

        return rest_ensure_response($categories);
    }

    // ==========================================
    // HELPER METHODS
    // ==========================================

    private function get_product_images($product) {
        $images = array();

        // Hauptbild
        $image_id = $product->get_image_id();
        if ($image_id) {
            $images[] = array(
                'id' => $image_id,
                'src' => wp_get_attachment_url($image_id),
                'src_thumbnail' => wp_get_attachment_image_url($image_id, 'thumbnail'),
                'src_medium' => wp_get_attachment_image_url($image_id, 'medium'),
                'src_large' => wp_get_attachment_image_url($image_id, 'large'),
                'name' => get_the_title($image_id),
                'alt' => get_post_meta($image_id, '_wp_attachment_image_alt', true)
            );
        }

        // Galerie
        $gallery_ids = $product->get_gallery_image_ids();
        foreach ($gallery_ids as $image_id) {
            $images[] = array(
                'id' => $image_id,
                'src' => wp_get_attachment_url($image_id),
                'src_thumbnail' => wp_get_attachment_image_url($image_id, 'thumbnail'),
                'src_medium' => wp_get_attachment_image_url($image_id, 'medium'),
                'src_large' => wp_get_attachment_image_url($image_id, 'large'),
                'name' => get_the_title($image_id),
                'alt' => get_post_meta($image_id, '_wp_attachment_image_alt', true)
            );
        }

        return $images;
    }

    private function get_product_categories($product) {
        $category_ids = $product->get_category_ids();
        $categories = array();

        foreach ($category_ids as $cat_id) {
            $category = get_term($cat_id, 'product_cat');
            if ($category) {
                $categories[] = array(
                    'id' => $category->term_id,
                    'name' => $category->name,
                    'slug' => $category->slug
                );
            }
        }

        return $categories;
    }

    private function get_product_tags($product) {
        $tag_ids = $product->get_tag_ids();
        $tags = array();

        foreach ($tag_ids as $tag_id) {
            $tag = get_term($tag_id, 'product_tag');
            if ($tag) {
                $tags[] = array(
                    'id' => $tag->term_id,
                    'name' => $tag->name,
                    'slug' => $tag->slug
                );
            }
        }

        return $tags;
    }

    private function get_product_attributes($product) {
        $attributes = array();
        foreach ($product->get_attributes() as $attribute) {
            $attributes[] = array(
                'id' => $attribute->get_id(),
                'name' => $attribute->get_name(),
                'options' => $attribute->get_options(),
                'visible' => $attribute->get_visible(),
                'variation' => $attribute->get_variation()
            );
        }
        return $attributes;
    }
}

// Initialize Product Data API
new Jaeger_Product_Data_API();
